<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stealth Classroom</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --ninja-navy: #2a3b90; 
            --ninja-dark-bg: #1a1a2e; 
            --green: #4caf50;
            --orange: #ff9800;
            --red: #f44336;
            --gold: #ffd700;
            --white: #ffffff;
            --pixel-font: 'Press Start 2P', 'Courier New', monospace;
        }

        body, html {
            height: 100%; margin: 0;
            background-color: #000;
            background-image: url('background.png'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: var(--white);
            font-family: var(--pixel-font);
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            transition: background-image 0.5s ease-in-out;
        }

        /* --- GLOBAL UI ELEMENTS --- */
        button {
            padding: 15px 30px;
            font-family: var(--pixel-font);
            font-size: 0.8rem;
            background-color: var(--ninja-navy);
            color: var(--white);
            border: 3px solid var(--gold); 
            box-shadow: 3px 3px 0px var(--ninja-dark-bg); 
            cursor: pointer; transition: all 0.1s;
            text-transform: uppercase;
        }
        button:hover { 
            background-color: #3a4ba0; 
            border-color: var(--white); 
            box-shadow: 3px 3px 0px var(--white); 
            transform: translate(-1px, -1px); 
        }
        button:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0px var(--ninja-dark-bg); }
        button:disabled { opacity: 0.5; cursor: not-allowed; border-color: #555; box-shadow: none; }

        .input-box {
            padding: 15px;
            font-family: var(--pixel-font);
            background: var(--ninja-dark-bg);
            color: var(--white);
            border: 3px solid var(--gold);
            margin-bottom: 10px; width: 450px; 
            text-align: center; outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-box:focus { border-color: var(--white); box-shadow: 0 0 10px var(--gold); }
        .input-success { border-color: var(--green) !important; color: var(--green) !important; }

        /* --- SCREENS --- */
        #setup-screen {
            display: flex; flex-direction: column; 
            justify-content: flex-start; 
            align-items: center; 
            height: 100vh;
            margin-top: 0; 
            padding-top: 80px;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.5);
            box-sizing: border-box;
        }
        #game-container, #results-screen { 
            display: none; flex-direction: column;
            justify-content: center; align-items: center; 
            height: 100vh;
            margin-top: 0;
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* --- TOP HEADER BUTTONS --- */
        .top-btn {
            position: fixed; top: 20px; z-index: 3000;
            font-size: 0.6rem; padding: 10px; 
            width: 160px; text-align: center;
            background-color: var(--ninja-navy);
            border: 3px solid var(--gold);
        }
        #leaderboard-toggle-btn { left: 20px; }
        #store-toggle-btn { left: 200px; }
        
        #briefingBtn { right: 20px; width: 220px; top: 20px; }

        /* --- UI CARDS --- */
        .ui-card {
            background: var(--ninja-navy);
            border: 4px solid var(--gold);
            box-shadow: inset 0 0 0 2px var(--ninja-dark-bg), 4px 4px 0 var(--ninja-dark-bg);
            padding: 30px; width: 80%; max-width: 700px;
            text-align: center; max-height: 80vh; overflow-y: auto;
        }
        #results-screen .ui-card {
            background-color: rgba(42, 59, 144, 0.85);
        }
        
        /* --- LOGO BOX --- */
        .logo-box {
            background: transparent; border: none; box-shadow: none; padding: 0; 
            width: 100%; max-width: 850px; 
            margin-bottom: 20px; margin-top: 0px; 
            box-sizing: border-box; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .logo-box img { max-height: 300px; width: auto; max-width: 100%; }

        /* --- RANK UP CELEBRATION --- */
        @keyframes rank-flash {
            0% { color: var(--gold); transform: scale(1); text-shadow: 0 0 10px var(--gold); }
            100% { color: var(--white); transform: scale(1.1); text-shadow: 4px 4px 0 #000; }
        }
        .rank-up-active { animation: rank-flash 0.4s infinite alternate !important; }

        /* --- OVERLAYS --- */
        #leaderboard-overlay, #briefing-overlay, #store-overlay, #welcome-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 4000; flex-direction: column;
            justify-content: center; align-items: center;
        }

        /* --- WELCOME TEXT --- */
        .welcome-text p {
            font-size: 0.7rem; line-height: 1.6; color: #ddd; margin-bottom: 15px; text-align: left;
        }
        .welcome-highlight { color: var(--gold); }

        /* --- STORE STYLES --- */
        #store-balance-box { background: #000; border: 2px solid var(--gold); padding: 10px; margin-bottom: 20px; color: var(--gold); }
        #store-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; max-height: 350px; overflow-y: auto; width: 100%; padding: 0 10px; box-sizing: border-box; }
        .store-row { background: var(--ninja-dark-bg); border: 2px solid var(--gold); padding: 15px; display: flex; justify-content: space-between; align-items: center; text-align: left; }
        .store-left { display: flex; align-items: center; gap: 15px; }
        .store-right { display: flex; align-items: center; gap: 15px; }
        .store-name { font-size: 0.7rem; color: var(--white); line-height: 1.4; }
        .store-price { color: var(--gold); font-size: 0.7rem; }
        
        .delete-item-x {
            width: 30px; height: 30px; border: 2px solid var(--red); background-color: var(--ninja-dark-bg); color: var(--red);
            font-weight: bold; font-size: 0.8rem; display: flex; justify-content: center; align-items: center;
            cursor: pointer; margin-left: 10px; transition: all 0.2s;
        }
        .delete-item-x:hover { color: #fff; background: var(--red); border-color: var(--white); }
        #restock-panel { display: none; border-top: 2px dashed var(--gold); padding-top: 20px; margin-top: 20px; }
        .restock-input { width: 80%; padding: 10px; margin-bottom: 10px; font-family: var(--pixel-font); font-size: 0.6rem; }

        /* --- LEADERBOARD --- */
        .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.7rem; }
        .leaderboard-table th { color: var(--gold); padding-bottom: 15px; text-shadow: 2px 2px #000; }
        .leaderboard-table td { padding: 10px; border-bottom: 2px solid var(--gold); }
        .top-rank { color: var(--gold); }

        /* --- CLASS SELECTION --- */
        #class-directory {
            display: none; flex-wrap: wrap; justify-content: center;
            gap: 10px; max-width: 600px; margin-bottom: 5px;
            max-height: 100px; overflow-y: auto; align-content: flex-start;
        }
        .class-badge {
            padding: 8px 12px; background: var(--ninja-navy); border: 2px solid var(--gold);
            font-size: 0.6rem; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 10px; box-shadow: 2px 2px 0 var(--ninja-dark-bg);
        }
        .class-badge:hover { border-color: var(--white); background: #3a4ba0; transform: translate(-1px, -1px); }
        .remove-btn { color: var(--red); font-weight: bold; font-size: 0.8rem; padding: 2px 5px; }
        
        #arrow-helper { color: var(--gold); font-size: 0.7rem; margin-bottom: 5px; text-shadow: 2px 2px #000; display: none; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        /* --- SLIDER --- */
        #vibe-labels { display: flex; justify-content: space-between; width: 420px; font-size: 0.6rem; color: var(--gold); margin-bottom: 5px; letter-spacing: 1px; text-shadow: 2px 2px #000; }
        .stealth-label { color: var(--green); text-shadow: 0 0 5px var(--green); }
        input[type=range] { -webkit-appearance: none; width: 420px; margin-bottom: 10px; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 12px; background: var(--ninja-dark-bg); border: 3px solid var(--gold); }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 12px; background: var(--gold); border: 2px solid var(--white); margin-top: -8px; cursor: pointer; }

        /* --- HUD --- */
        #top-hud {
            display: flex; justify-content: space-between; width: 100%; position: absolute; top: 0;
            padding: 30px; box-sizing: border-box; background-color: rgba(42, 59, 144, 0.9); border-bottom: 4px solid var(--gold);
            height: 110px;
        }
        .hud-item { 
            font-size: 0.9rem; 
            text-shadow: 2px 2px #000; 
            display: flex; 
            flex-direction: column;
            justify-content: center;
        }
        
        #hearts {
            display: block;
            margin: 2px 0 10px 0; 
            line-height: 1; 
        }
        .total-stat { color: var(--gold); font-size: 0.7rem; margin-top: 12px; }

        /* --- MISSION CENTER --- */
        #mission-center { gap: 20px; width: 100%; display: flex; flex-direction: column; align-items: center; }
        #progress-wrapper {
            width: 85%; height: 60px; background-color: #222; border: 4px solid var(--gold); position: relative; margin-top: 60px;
            box-shadow: 4px 4px 0 var(--ninja-dark-bg);
        }
        #progress-wrapper::after {
            content: ''; position: absolute; top: 0; right: 0; bottom: 0; width: 30px;
            background-color: var(--white); border-left: 4px solid var(--gold); z-index: 0;
            background-image: linear-gradient(45deg, #000 25%, transparent 25%), linear-gradient(-45deg, #000 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #000 75%), linear-gradient(-45deg, transparent 75%, #000 75%);
            background-size: 15px 15px;
        }
        #progress-bar { width: 0%; height: 100%; background-color: var(--green); position: relative; z-index: 1; transition: background-color 0.3s; }
        
        .flag-container { position: absolute; top: -65px; display: flex; z-index: 10; pointer-events: none; }
        .flag-pole { width: 8px; height: 65px; background-color: var(--white); border: 2px solid #000; }
        .flag-fabric { width: 45px; height: 30px; clip-path: polygon(0 0, 100% 0, 85% 25%, 100% 50%, 85% 75%, 100% 100%, 0 100%); border: 2px solid #000; }
        .flag-red .flag-fabric { background-color: var(--red); }
        .flag-green .flag-fabric { background-color: var(--green); }

        #timer-display { margin: 10px 0; text-shadow: 3px 3px #000; }
        #timer-label { font-size: 1.2rem; min-height: 2.5rem; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; color: var(--gold); }
        #timer { font-size: 3rem; }
        #bonus-sign { display: none; color: var(--gold); font-size: 1.5rem; text-shadow: 3px 3px #000; animation: flash 0.6s infinite alternate; margin-bottom: 20px;}
        @keyframes flash { from { opacity: 1; } to { opacity: 0.3; } }

        /* XP LOST SIGN */
        #xp-lost-sign {
            display: none;
            position: absolute;
            top: 40%;
            color: var(--red);
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 4px 4px 0 #000;
            z-index: 500;
            background-color: rgba(0,0,0,0.7);
            padding: 20px;
            border: 4px solid var(--red);
        }

        .action-container { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
        #finishBtn { display: none; background-color: var(--green); border-color: var(--gold); }
        #abortBtn { background-color: var(--red); border-color: var(--gold); font-size: 0.7rem; padding: 10px 20px; }
        #abortBtn:hover { border-color: var(--white); background-color: #d32f2f; }
        
        /* NEW ESCAPE BUTTON */
        #escapeBtn { background-color: var(--orange); border-color: var(--gold); font-size: 0.7rem; padding: 10px 20px; }
        #escapeBtn:hover { border-color: var(--white); background-color: #e65100; }
        
        /* NEW BUTTON STYLE FOR CALIBRATE MAIN */
        #calibrate-btn-main {
            width: 450px; 
            margin-bottom: 10px; 
            background-color: var(--ninja-navy);
            border: 3px solid var(--gold);
            font-size: 0.7rem;
            padding: 10px;
        }
        #calibrate-btn-main.active { background-color: var(--red); border-color: var(--white); animation: pulse 1s infinite; }


        .gold-heading { color: var(--gold); text-shadow: 3px 3px #000; margin-bottom: 30px; }
        #store-overlay .gold-heading { font-size: 2.5rem; }

        /* --- NINJA MASCOT --- */
        #ninja-mascot { 
            position: fixed; bottom: 80px; left: 30px; 
            width: 300px; 
            image-rendering: pixelated; z-index: 100;
            transition: opacity 1.5s steps(10, end), transform 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .ninja-hidden { opacity: 0; pointer-events: none; }

        /* --- PIXEL ICONS --- */
        .pixel-icon { display: inline-block; width: 22px; height: 20px; margin-right: 25px; position: relative; }
        
        .pixel-heart {
            width: 3px; height: 3px; background-color: transparent;
            box-shadow: 3px 0 var(--red), 6px 0 var(--red), 12px 0 var(--red), 15px 0 var(--red), 
                0 3px var(--red), 3px 3px var(--red), 6px 3px var(--red), 9px 3px var(--red), 12px 3px var(--red), 15px 3px var(--red), 18px 3px var(--red), 
                0 6px var(--red), 3px 6px var(--red), 6px 6px var(--red), 9px 6px var(--red), 12px 6px var(--red), 15px 6px var(--red), 18px 6px var(--red), 
                3px 9px var(--red), 6px 9px var(--red), 9px 9px var(--red), 12px 9px var(--red), 15px 9px var(--red), 
                6px 12px var(--red), 9px 12px var(--red), 12px 12px var(--red), 
                9px 15px var(--red);
            margin-top: 2px;
        }
        .pixel-cross {
            width: 3px; height: 3px; background-color: transparent;
            box-shadow: 0 0 #555, 12px 0 #555, 3px 3px #555, 9px 3px #555, 6px 6px #555, 3px 9px #555, 9px 9px #555, 0 12px #555, 12px 12px #555;
            margin-top: 4px; margin-left: 2px;
        }
    </style>
</head>
<body>

    <button id="leaderboard-toggle-btn" class="top-btn" onclick="toggleLeaderboard(true)">RANKINGS</button>
    <button id="store-toggle-btn" class="top-btn" onclick="toggleStore(true)">XP STORE</button>
    <button id="briefingBtn" class="top-btn" onclick="toggleBriefing(true)">MISSION GUIDELINES</button>

    <div id="welcome-overlay">
        <div class="ui-card welcome-text">
            <h2 class="gold-heading">STEALTH CLASSROOM</h2>
            <p>Welcome, Sensei. This tool helps your students master the art of silence.</p>
            
            <p><span class="welcome-highlight">‚ñ∫ HOW IT WORKS:</span><br>
            The Ninja watches the class. If the noise bar hits RED, you lose a heart. Keep it green to earn XP and rank up!</p>
            
            <p><span class="welcome-highlight">‚ñ∫ DATA WARNING:</span><br>
            All Class Data and XP is saved <b>ON THIS DEVICE</b>. If you clear your browser cache, the data will vanish.</p>
            
            <p><span class="welcome-highlight">‚ñ∫ THE STORE:</span><br>
            Students earn XP for completing sessions. Use XP in the Store to buy rewards (like "10 Mins Free Time").</p>

            <button onclick="closeWelcome()" style="margin-top: 20px; width: 100%;">I UNDERSTAND - START MISSION</button>
        </div>
    </div>

    <div id="store-overlay">
        <div class="ui-card">
            <h2 class="gold-heading">XP STORE</h2>
            <div id="store-balance-box">TOTAL XP: <span id="store-wallet">0</span></div>
            <div id="store-list"></div>
            <button onclick="toggleRestockPanel()" style="font-size: 0.6rem; width: 100%; margin-bottom: 10px;">RESTOCK STORE</button>
            <div id="restock-panel">
                <input type="text" id="newItemName" class="restock-input" placeholder="REWARD NAME">
                <input type="number" id="newItemPrice" class="restock-input" placeholder="COST (XP)">
                <button onclick="addNewStoreItem()">ADD TO SHELF</button>
            </div>
            <button onclick="toggleStore(false)" style="margin-top: 20px;">CLOSE STORE</button>
        </div>
    </div>

    <div id="leaderboard-overlay">
        <div class="leaderboard-card ui-card">
            <h2 class="gold-heading">HALL OF FAME</h2>
            <table class="leaderboard-table">
                <thead><tr><th>RANK</th><th>CLASS</th><th>TOTAL XP</th></tr></thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
            <button onclick="toggleLeaderboard(false)" style="margin-top: 30px;">CLOSE</button>
        </div>
    </div>

    <div id="briefing-overlay">
        <div class="briefing-card ui-card">
            <h2 class="gold-heading" style="text-align: center;">MISSION BRIEFING</h2>
            <div id="student-rules">
                <p> <b>CHECKPOINTS:</b> Reach flags to earn XP.</p>
                <p> <b>TIME BONUS:</b> +1 XP every minute.</p>
                <p> <b>MISSION END:</b> Reach the end for a big bonus.</p>
                <p> <b>LIVES:</b> 3 hearts per checkpoint.</p>
            </div>
            <div id="teacher-intel" class="intel-box" style="display:none;">
                <h3 style="color: var(--gold); margin-top: 0; text-shadow: 2px 2px #000;">TEACHER INTEL</h3>
                <p>‚Ä¢ <b>XP REWARD:</b> 1 XP/Min + Flag Bonuses.</p>
                <button id="resetDataBtn" onclick="resetAllData()">WIPE ALL MISSION DATA</button>
            </div>
            <button id="teacherInfoBtn" onclick="toggleTeacherIntel()" style="margin-top: 20px; width: 100%;">TOP SECRET TEACHER INTEL</button>
            <div style="text-align: center; margin-top: 20px;"><button onclick="toggleBriefing(false)">START SESSION</button></div>
        </div>
    </div>

    <div id="setup-screen">
        <div class="logo-box">
            <img src="banner.png" alt="Stealth Classroom">
        </div>
        
        <div id="class-directory"></div>
        <div id="arrow-helper">‚¨Ü SELECT EXISTING ‚¨Ü</div>
        <input type="text" id="classInput" class="input-box" placeholder="ENTER CLASS OR SELECT EXISTING">
        
        <select id="timeInput" class="input-box">
            <option value="0.5">30 SECONDS (TEST)</option>
            <option value="5">5 MINUTES</option>
            <option value="10">10 MINUTES</option>
            <option value="15">15 MINUTES</option>
            <option value="30">30 MINUTES</option>
            <option value="45">45 MINUTES</option>
            <option value="60">60 MINUTES</option>
        </select>
        
        <div style="margin-top: 10px; width: 100%; display: flex; flex-direction: column; align-items: center;">
            <button id="calibrate-btn-main" onclick="runCalibration()">SET BASELINE NOISE</button>
            <div id="vibe-labels">
                <span class="stealth-label">STEALTH SILENCE</span>
                <span>COLLABORATION</span>
            </div>
            <input type="range" id="sensitivity" min="10" max="80" value="35" step="5">
            <div style="font-size: 0.8rem; margin-bottom: 20px; color: var(--gold); text-shadow: 2px 2px #000;">THRESHOLD: <span id="thresh-val">35</span></div>
        </div>
        
        <button id="startBtn" onclick="startMission()" style="font-size: 1.2rem; padding: 15px 40px;">START MISSION</button>
    </div>

    <div id="game-container">
        <div id="top-hud">
            <div class="hud-item">
                <div>LIVES</div>
                <span id="hearts"></span>
                <div class="total-stat">STREAK: <span id="streak-val">0</span> </div>
            </div>
            <div class="hud-item" style="align-items: flex-end; text-align: right;">
                <div>SESSION XP: <span id="xp">0</span></div>
                <div class="total-stat">TOTAL XP: <span id="total-xp-val">0</span></div>
            </div>
        </div>
        <div id="mission-center">
            <div id="xp-lost-sign">XP LOST!</div>
            <div id="bonus-sign"> BONUS XP ZONE </div>
            <div id="progress-wrapper">
                <div id="flag1" class="flag-container flag-red" style="left: 33.33%;"><div class="flag-pole"></div><div class="flag-fabric"></div></div>
                <div id="flag2" class="flag-container flag-red" style="left: 66.66%;"><div class="flag-pole"></div><div class="flag-fabric"></div></div>
                <div id="progress-bar"></div>
            </div>
            <div id="timer-display">
                <div id="timer-label">TIME:</div>
                <div id="timer">00:00</div>
            </div>
            <div id="class-display" style="color: var(--gold); font-size: 1.2rem; margin-top: 20px; text-shadow: 2px 2px #000;"></div>
            <div class="action-container">
                <button id="finishBtn" onclick="endSession()">CLAIM XP & FINISH</button>
                <button id="escapeBtn" onclick="escapeMission()">ESCAPE WITH XP</button>
                <button id="pauseBtn" onclick="togglePause()">PAUSE</button>
                <button id="abortBtn" onclick="abortMission()">ABORT MISSION</button>
            </div>
        </div>
    </div>

    <div id="results-screen">
        <div class="ui-card">
            <h2 class="gold-heading">MISSION REPORT</h2>
            <div id="rank-display" style="font-size: 1.5rem; margin-bottom: 20px; color: var(--gold); text-shadow: 2px 2px #000;">RANK: WHITE BELT</div>
            <div id="typewriter-text" style="font-size: 1rem; line-height: 1.6; margin-bottom: 40px;"></div>
            
            <div class="action-container" style="flex-direction: column; align-items: center; gap: 15px; width: 100%;">
                <button onclick="toggleLeaderboard(true)" style="width: 80%;">RANKINGS</button>
                <button onclick="toggleStore(true)" style="width: 80%;">XP STORE</button>
                <button onclick="location.reload()" style="width: 80%;">MAIN MENU</button>
            </div>
        </div>
    </div>

    <img id="ninja-mascot" src="ninja1.png" alt="Ninja">

    <img src="background3.png" style="display: none;" alt="preload">

    <script>
        let audioContext, analyser, microphone;
        let duration, elapsedSeconds = 0, isPaused = false, isBonusZone = false;
        let strikes = 0, sessionXP = 0, redTimer = 0;
        let currentThreshold = 35, lastTimestamp = 0, currentClassName = "";
        
        let flag1Claimed = false, flag2Claimed = false, completionXPClaimed = false;
        let minutesTracked = 0; 

        const h = '<i class="pixel-icon pixel-heart"></i>'; 
        const x = '<i class="pixel-icon pixel-cross"></i>'; 
        const heartIcons = [ h+h+h, h+h+x, h+x+x, x+x+x ];

        const ranks = [
            { threshold: 1000, name: "BLACK BELT", color: "#333333" },
            { threshold: 500, name: "RED BELT", color: "#f44336" },
            { threshold: 250, name: "BLUE BELT", color: "#2196f3" },
            { threshold: 100, name: "GREEN BELT", color: "#4caf50" },
            { threshold: 50, name: "YELLOW BELT", color: "#ffeb3b" },
            { threshold: 0, name: "WHITE BELT", color: "#ffffff" }
        ];

        function getRankInfo(xp) { return ranks.find(r => xp >= r.threshold); }

        const defaultStoreItems = [
            { name: "10 Mins Free Time", cost: 150 },
            { name: "Lollipops For All", cost: 200 },
            { name: "No Homework Pass", cost: 300 }
        ];

        // --- INIT & NINJA SWAP LOGIC ---
        window.onload = function() { 
            checkFirstVisit();
            updateDirectoryUI(); 
            if(!localStorage.getItem('ninja_store_items')) {
                localStorage.setItem('ninja_store_items', JSON.stringify(defaultStoreItems));
            }

            // ENTER KEY LISTENER
            document.getElementById('classInput').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    this.classList.add('input-success');
                    this.blur(); 
                    setTimeout(() => { this.classList.remove('input-success'); }, 1000);
                }
            });

            // START ANIMATION LOOP
            startNinjaCycle();
        };

        function checkFirstVisit() {
            const hasVisited = localStorage.getItem('stealthClassroom_visited');
            if (!hasVisited) {
                document.getElementById('welcome-overlay').style.display = 'flex';
            }
        }

        function closeWelcome() {
            localStorage.setItem('stealthClassroom_visited', 'true');
            document.getElementById('welcome-overlay').style.display = 'none';
        }

        // Ninja Loop (7s Ninja1 -> 3s Ninja2)
        function startNinjaCycle() {
            const ninja = document.getElementById('ninja-mascot');
            
            function showNinja1() {
                // Check if game has started (setup screen hidden). If so, stop loop.
                if(document.getElementById('setup-screen').style.display === 'none') return; 
                ninja.src = 'ninja1.png';
                setTimeout(showNinja2, 7000);
            }

            function showNinja2() {
                // Check if game has started (setup screen hidden). If so, stop loop.
                if(document.getElementById('setup-screen').style.display === 'none') return;
                ninja.src = 'ninja2.png';
                setTimeout(showNinja1, 3000);
            }

            // Start the cycle
            showNinja1();
        }

        function resetAllData() {
            if (confirm(" DANGER: This will delete all data forever. Proceed?")) {
                localStorage.clear(); location.reload();
            }
        }

        function toggleTeacherIntel() {
            const intel = document.getElementById('teacher-intel');
            const btn = document.getElementById('teacherInfoBtn');
            intel.style.display = intel.style.display === 'block' ? 'none' : 'block';
            btn.innerText = intel.style.display === 'block' ? "CLOSE INTEL" : "TOP SECRET TEACHER INTEL";
        }

        async function runCalibration() {
            const btn = document.getElementById('calibrate-btn-main');
            btn.innerText = "LISTENING..."; btn.classList.add('active'); btn.disabled = true;

            if (!audioContext) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioContext = new AudioContext();
                    analyser = audioContext.createAnalyser();
                    microphone = audioContext.createMediaStreamSource(stream);
                    analyser.fftSize = 256;
                    microphone.connect(analyser);
                } catch(e) { alert("Mic required!"); return; }
            }

            let samples = [], count = 0;
            const interval = setInterval(() => {
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(dataArray);
                let volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
                samples.push(volume); count++;

                if (count >= 50) {
                    clearInterval(interval);
                    let avg = samples.reduce((a, b) => a + b) / samples.length;
                    currentThreshold = Math.max(15, Math.min(Math.round(avg + 15), 80));
                    document.getElementById('sensitivity').value = currentThreshold;
                    document.getElementById('thresh-val').innerText = currentThreshold;
                    btn.innerText = "READY!"; btn.classList.remove('active'); btn.disabled = false;
                    setTimeout(() => { btn.innerText = "SET BASELINE NOISE"; }, 3000);
                }
            }, 100);
        }

        document.getElementById('sensitivity').oninput = function() {
            currentThreshold = this.value;
            document.getElementById('thresh-val').innerText = this.value;
        };

        function toggleLeaderboard(show) {
            const overlay = document.getElementById('leaderboard-overlay');
            if(show) { renderLeaderboardData(); overlay.style.display = 'flex'; } else { overlay.style.display = 'none'; }
        }

        function renderLeaderboardData() {
            const directory = JSON.parse(localStorage.getItem('ninja_directory') || "[]");
            const body = document.getElementById('leaderboard-body');
            body.innerHTML = "";
            let allData = directory.map(name => {
                let stats = JSON.parse(localStorage.getItem('ninja_' + name) || '{"totalXP":0}');
                return { name: name, xp: stats.totalXP };
            });
            allData.sort((a, b) => b.xp - a.xp).forEach((item, index) => {
                let rankDisplay = (index === 0) ? "üèÜ 1ST" : (index + 1);
                body.innerHTML += `<tr><td class="${index === 0 ? 'top-rank' : ''}">${rankDisplay}</td><td>${item.name}</td><td>${item.xp}</td></tr>`;
            });
        }

        function toggleStore(show) {
            const overlay = document.getElementById('store-overlay');
            const classInput = document.getElementById('classInput').value.trim();
            const walletSpan = document.getElementById('store-wallet');
            
            if(show) {
                if(!classInput) { walletSpan.innerText = "??? (ENTER CLASS)"; } else {
                    let key = 'ninja_' + classInput.toUpperCase();
                    let stats = JSON.parse(localStorage.getItem(key) || '{"totalXP":0}');
                    walletSpan.innerText = stats.totalXP;
                }
                renderStoreItems(); overlay.style.display = 'flex';
            } else {
                overlay.style.display = 'none'; document.getElementById('restock-panel').style.display = 'none';
            }
        }

        function renderStoreItems() {
            const list = document.getElementById('store-list');
            const items = JSON.parse(localStorage.getItem('ninja_store_items') || "[]");
            list.innerHTML = "";
            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "store-row";
                div.innerHTML = `
                    <div class="store-left"><span class="store-name">${item.name}</span></div>
                    <div class="store-right">
                        <span class="store-price">${item.cost} XP</span>
                        <button onclick="buyItem(${index}, ${item.cost})" style="font-size:0.6rem; padding: 5px 10px;">BUY</button>
                        <div class="delete-item-x" onclick="removeStoreItem(${index})">X</div>
                    </div>`;
                list.appendChild(div);
            });
        }

        function buyItem(index, cost) {
            const classInput = document.getElementById('classInput').value.trim();
            if(!classInput) { alert("Please enter a Class Name on the main screen to access Total XP."); return; }
            let key = 'ninja_' + classInput.toUpperCase();
            let stats = JSON.parse(localStorage.getItem(key) || '{"totalXP":0,"streak":0}');
            if(stats.totalXP >= cost) {
                if(confirm(`Purchase this for ${cost} XP?`)) {
                    stats.totalXP -= cost; localStorage.setItem(key, JSON.stringify(stats));
                    document.getElementById('store-wallet').innerText = stats.totalXP; alert("ITEM ACQUIRED! XP DEDUCTED.");
                }
            } else { alert("INSUFFICIENT XP! Keep playing to earn more."); }
        }

        function toggleRestockPanel() {
            const panel = document.getElementById('restock-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        function addNewStoreItem() {
            const name = document.getElementById('newItemName').value;
            const cost = parseInt(document.getElementById('newItemPrice').value);
            if(name && cost) {
                const items = JSON.parse(localStorage.getItem('ninja_store_items') || "[]");
                items.push({ name: name, cost: cost });
                localStorage.setItem('ninja_store_items', JSON.stringify(items));
                document.getElementById('newItemName').value = ""; document.getElementById('newItemPrice').value = "";
                renderStoreItems();
            } else { alert("Please enter both Name and Cost."); }
        }

        function removeStoreItem(index) {
            if(confirm("Are you sure you want to remove this item from the store?")) {
                const items = JSON.parse(localStorage.getItem('ninja_store_items') || "[]");
                items.splice(index, 1);
                localStorage.setItem('ninja_store_items', JSON.stringify(items));
                renderStoreItems();
            }
        }

        function updateDirectoryUI() {
            const directory = JSON.parse(localStorage.getItem('ninja_directory') || "[]");
            const container = document.getElementById('class-directory');
            const arrowHelper = document.getElementById('arrow-helper');
            container.innerHTML = "";
            if(directory.length > 0) {
                container.style.display = 'flex'; arrowHelper.style.display = 'block';
            } else {
                container.style.display = 'none'; arrowHelper.style.display = 'none';
            }
            directory.forEach(name => {
                const badge = document.createElement('div');
                badge.className = "class-badge";
                badge.innerHTML = `<span>${name}</span> <span class="remove-btn" onclick="removeClass(event, '${name}')">X</span>`;
                badge.onclick = () => { document.getElementById('classInput').value = name; };
                container.appendChild(badge);
            });
        }

        function removeClass(event, name) {
            event.stopPropagation();
            if (confirm(`DELETE CLASS ${name}?`)) {
                let directory = JSON.parse(localStorage.getItem('ninja_directory') || "[]").filter(item => item !== name);
                localStorage.setItem('ninja_directory', JSON.stringify(directory));
                localStorage.removeItem('ninja_' + name);
                updateDirectoryUI();
            }
        }

        function getRank(xp) {
            if (xp >= 1000) return "BLACK BELT";
            if (xp >= 500) return "RED BELT";
            if (xp >= 250) return "BLUE BELT";
            if (xp >= 100) return "GREEN BELT";
            if (xp >= 50) return "YELLOW BELT";
            return "WHITE BELT";
        }

        async function startMission() {
            // SWITCH BACKGROUND
            document.body.style.backgroundImage = "url('background2.png')";

            currentClassName = document.getElementById('classInput').value.trim() || "GUEST";
            let key = 'ninja_' + currentClassName.toUpperCase();
            let history = JSON.parse(localStorage.getItem(key) || '{"totalXP":0,"streak":0}');
            
            elapsedSeconds = 0; strikes = 0; sessionXP = 0;
            isBonusZone = false; lastTimestamp = 0;
            flag1Claimed = false; flag2Claimed = false; completionXPClaimed = false;
            minutesTracked = 0;
            
            document.getElementById('total-xp-val').innerText = history.totalXP;
            document.getElementById('streak-val').innerText = history.streak;
            document.getElementById('xp').innerText = "0";
            document.getElementById('hearts').innerHTML = heartIcons[0];
            
            duration = parseFloat(document.getElementById('timeInput').value) * 60;
            
            document.getElementById('class-display').innerText = currentClassName.toUpperCase();
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            // Ensure we hide the new top button too
            document.getElementById('briefingBtn').style.display = 'none';
            document.getElementById('leaderboard-toggle-btn').style.display = 'none';
            document.getElementById('store-toggle-btn').style.display = 'none';
            
            // ENSURE QUIET NINJA IS SHOWN FOR GAME
            const ninja = document.getElementById('ninja-mascot');
            ninja.src = 'ninja3.png';
            ninja.style.transition = ''; // Ensure transition is reset for start
            ninja.classList.remove('ninja-hidden');
            
            // --- UPDATED: MOVE NINJA3 UP 1/3 OF THE SCREEN ---
            ninja.style.bottom = '33vh'; 
            
            setTimeout(() => {
                if(!isPaused && document.getElementById('game-container').style.display === 'flex') {
                      ninja.classList.add('ninja-hidden');
                }
            }, 5000);

            if (!audioContext) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioContext = new AudioContext();
                    analyser = audioContext.createAnalyser();
                    microphone = audioContext.createMediaStreamSource(stream);
                    analyser.fftSize = 256;
                    microphone.connect(analyser);
                } catch(e) { alert("Mic required!"); return; }
            } else if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
            requestAnimationFrame(gameLoop);
        }

        function gameLoop(timestamp) {
            if (document.getElementById('game-container').style.display !== 'flex') return;
            if (!lastTimestamp) lastTimestamp = timestamp;
            const deltaTime = (timestamp - lastTimestamp) / 1000;
            lastTimestamp = timestamp;

            if (!isPaused && (strikes < 3 || isBonusZone)) {
                elapsedSeconds += deltaTime;
                if (analyser) {
                    const dataArray = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(dataArray);
                    let volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    const bar = document.getElementById('progress-bar');
                    if (volume > currentThreshold) {
                        redTimer++;
                        bar.style.backgroundColor = "var(--red)";
                        if (redTimer > 45) {
                            if (isBonusZone) {
                                if (strikes < 3) {
                                    strikes++;
                                    document.getElementById('hearts').innerHTML = heartIcons[strikes] || heartIcons[3];
                                } else {
                                    sessionXP = Math.max(0, sessionXP - 1);
                                    document.getElementById('xp').innerText = sessionXP;
                                    showXPLost();
                                    strikes = 0;
                                    document.getElementById('hearts').innerHTML = heartIcons[0];
                                }
                            } else { triggerStrike(); }
                            redTimer = 0;
                        }
                    } else {
                        bar.style.backgroundColor = volume > currentThreshold * 0.6 ? "var(--orange)" : "var(--green)";
                        redTimer = 0;
                    }
                }
                updateUI();
            }
            requestAnimationFrame(gameLoop);
        }

        function showXPLost() {
            const sign = document.getElementById('xp-lost-sign');
            sign.style.display = 'block';
            setTimeout(() => { sign.style.display = 'none'; }, 1000);
        }

        function updateUI() {
            const progress = Math.min(elapsedSeconds / duration, 1);
            document.getElementById('progress-bar').style.width = (progress * 100) + "%";
            
            // --- NEW XP TRACKING LOGIC ---
            // Calculate minutes passed
            let currentMins = Math.floor(elapsedSeconds / 60);
            if (currentMins > minutesTracked) {
                // Add 1 XP for the new minute
                sessionXP += 1;
                minutesTracked = currentMins;
                flashXPUpdate();
            }

            if (progress >= 0.33) {
                document.getElementById('flag1').classList.replace('flag-red', 'flag-green');
                if (!flag1Claimed) { sessionXP += 5; flag1Claimed = true; flashXPUpdate(); }
            }
            if (progress >= 0.66) {
                document.getElementById('flag2').classList.replace('flag-red', 'flag-green');
                if (!flag2Claimed) { sessionXP += 5; flag2Claimed = true; flashXPUpdate(); }
            }
            if (elapsedSeconds >= duration && !isBonusZone) {
                isBonusZone = true;
                document.getElementById('bonus-sign').style.display = 'block';
                document.getElementById('finishBtn').style.display = 'block';
                document.getElementById('timer-label').innerText = "BONUS:";
                if (!completionXPClaimed) { sessionXP += 10; completionXPClaimed = true; flashXPUpdate(); }
            }
            document.getElementById('xp').innerText = sessionXP;
            let displayTime = isBonusZone ? Math.max(0, elapsedSeconds - duration) : Math.max(duration - elapsedSeconds, 0);
            let mins = Math.floor(displayTime / 60), secs = Math.floor(displayTime % 60);
            document.getElementById('timer').innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function flashXPUpdate() {
            const xpText = document.getElementById('xp');
            xpText.style.color = 'var(--gold)';
            setTimeout(() => { xpText.style.color = '#fff'; }, 500);
        }

        function triggerStrike() {
            strikes++;
            document.getElementById('hearts').innerHTML = heartIcons[strikes] || heartIcons[3];
            if (strikes >= 3) {
                isPaused = true;
                setTimeout(() => {
                    elapsedSeconds = (elapsedSeconds >= duration * 0.66) ? duration * 0.66 : (elapsedSeconds >= duration * 0.33) ? duration * 0.33 : 0;
                    strikes = 0; isPaused = false;
                    document.getElementById('hearts').innerHTML = heartIcons[0];
                    // Also reset minutes tracked if time jumps back
                    minutesTracked = Math.floor(elapsedSeconds / 60);
                }, 1000);
            }
        }

        function togglePause() { isPaused = !isPaused; document.getElementById('pauseBtn').innerText = isPaused ? "RESUME" : "PAUSE"; }

        function abortMission() {
            if(confirm("ABORT MISSION? This will reset the streak to 0.")) {
                let key = 'ninja_' + currentClassName.toUpperCase();
                let data = JSON.parse(localStorage.getItem(key) || '{"totalXP":0,"streak":0}');
                data.streak = 0; localStorage.setItem(key, JSON.stringify(data));
                location.reload(); 
            }
        }
        
        function escapeMission() {
            // Confirm exit
            if(confirm("ESCAPE EARLY? You will keep your current XP and Streak.")) {
                endSession();
            }
        }

        function endSession() {
            const finalXPAdded = sessionXP;
            let key = 'ninja_' + currentClassName.toUpperCase();
            let data = JSON.parse(localStorage.getItem(key) || '{"totalXP":0,"streak":0}');
            const oldRankInfo = getRankInfo(data.totalXP);
            
            data.totalXP += finalXPAdded; data.streak += 1;
            localStorage.setItem(key, JSON.stringify(data));
            
            const newRankInfo = getRankInfo(data.totalXP);
            const isRankUp = (oldRankInfo.name !== newRankInfo.name);
            
            let directory = JSON.parse(localStorage.getItem('ninja_directory') || "[]");
            if (!directory.includes(currentClassName.toUpperCase())) {
                directory.push(currentClassName.toUpperCase());
                localStorage.setItem('ninja_directory', JSON.stringify(directory));
            }
            
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('results-screen').style.display = 'flex';
            
            document.body.style.backgroundImage = "url('background3.png')"; // SWITCH TO FINAL BG

            // CHANGE MASCOT TO DONE.PNG
            const mascot = document.getElementById('ninja-mascot');
            mascot.src = 'done.png'; 
            mascot.classList.remove('ninja-hidden'); 

            // --- UPDATED: MOVE CENTRAL, REDUCE SIZE ---
            mascot.style.width = '225px'; 
            mascot.style.left = '28%';    // Moved centrally over the box
            mascot.style.bottom = '15%';  

            // --- UPDATED: 5 SECONDS THEN INSTANT VANISH ---
            setTimeout(() => {
                mascot.style.transition = 'none'; // Ensure instant vanish
                mascot.classList.add('ninja-hidden');
            }, 5000);
            
            const rankDisplay = document.getElementById('rank-display');
            rankDisplay.innerText = "RANK: " + newRankInfo.name;
            rankDisplay.style.color = newRankInfo.color;

            let missionMessage = `MISSION SUCCESS! YOU EARNED ${finalXPAdded} XP. MISSION STREAK: ${data.streak}.`;
            if (isRankUp) {
                missionMessage = `üéâ GRADING PASSED! üéâ\nTHE ${currentClassName.toUpperCase()} CLAN IS NOW ${newRankInfo.name}!\n\n` + missionMessage;
                rankDisplay.classList.add('rank-up-active'); 
            } else { rankDisplay.classList.remove('rank-up-active'); }

            document.getElementById('typewriter-text').innerText = missionMessage;
        }

        function toggleBriefing(show) { document.getElementById('briefing-overlay').style.display = show ? 'flex' : 'none'; }
    </script>
</body>
</html>